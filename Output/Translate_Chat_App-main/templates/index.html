<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Translate Chat Webapp</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- 모바일 최적화 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f4f4f4;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
    
            h1 {
                color: #333;
                text-align: center;
                margin-bottom: 20px;
                font-size: 1.5em; /* 모바일 환경에 적합한 폰트 크기 */
            }
    
            .chat-container {
                width: 90%;
                background-color: #fff;
                border-radius: 8px;
                box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
                padding: 20px;
                box-sizing: border-box;
            }
    
            .settings {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
            }
    
            label {
                font-weight: bold;
                margin-right: 10px;
            }
    
            select, input[type="text"] {
                padding: 8px;
                font-size: 12px;
                border-radius: 4px;
                border: 1px solid #ccc;
                width: 100%; /* 모바일에서 넓이 조정 */
                box-sizing: border-box;
                margin-top: 5px;
            }
    
            .chat-box {
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap; /* 모바일에서 flex 항목이 내려가도록 처리 */
            }
    
            #original-box, #translated-box {
                width: 49.5%;
                height: 300px;
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 10px;
                overflow-y: scroll;
                background-color: #fafafa;
                box-sizing: border-box;
                margin-bottom: 10px;
            }
    
            #original-box h3, #translated-box h3 {
                color: #555;
                margin-top: 0;
                font-size: 11px;
            }
    
            #original-box p, #translated-box p {
                font-size: 10.5px;
                background-color: #f1f1f1;
                padding: 8px;
                border-radius: 10px;
                margin-bottom: 10px;
                color: #333;
            }
    
            #translated-box p {
                background-color: #e1f5fe;
            }
    
            .input-container {
                display: flex;
                margin-top: 20px;
                justify-content: center;
            }
    
            #message {
                width: 100%;
                padding: 12px;
                font-size: 14px;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }
    
            button {
                background-color: #4CAF50;
                color: white;
                padding: 12px 20px;
                margin-left: 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }
    
            button:hover {
                background-color: #45a049;
            }
    
            /* 모바일 화면을 위한 반응형 처리 */
            @media screen and (max-width: 768px) {
                .chat-container {
                    width: 90%;
                    padding: 10px;
                }
    
                h1 {
                    font-size: 1.2em; /* 작은 화면에서 폰트 크기 조정 */
                }
    
                .settings {
                    flex-direction: column; /* 설정 부분을 세로로 배치 */
                    gap: 10px;
                }
    
                .chat-box {
                    flex-direction: column; /* 메시지 박스를 세로로 배치 */
                }
    
                #original-box, #translated-box {
                    width: 100%; /* 메시지 박스를 전체 너비로 변경 */
                    height: 200px; /* 높이를 조정 */
                }
    
                select, input[type="text"], #message {
                    font-size: 12px; /* 폰트 크기를 더 작게 조정 */
                }
    
                button {
                    font-size: 12px; /* 버튼 폰트 크기 조정 */
                }
            }
        </style>
    </head>
<body>
    <div class="chat-container">
        <h1>Translate Chat Webapp</h1>

        <!-- 번역할 언어 선택 및 문체 입력 -->
        <div class="settings">
            <div>
                <label for="language">Language:</label>
                <select id="language">
                    <option value="English">English</option>
                    <option value="Japanese">Japanese</option>
                    <option value="Chinese">Chinese</option>
                    <option value="Korean">Korean</option>
                </select>
            </div>
            <div>
                <label for="tone">tone:</label>
                <input type="text" id="tone" placeholder="ex) formal, casual">
            </div>
        </div>

        <!-- 채팅창 구분 (입력된 언어와 번역된 언어) -->
        <div class="chat-box">
            <!-- 입력된 언어 출력 -->
            <div id="original-box">
                <h3>input message</h3>
            </div>

            <!-- 번역된 언어 출력 -->
            <div id="translated-box">
                <h3>translated</h3>
            </div>
        </div>

        <!-- 메시지 입력 및 전송 -->
        <div class="input-container">
            <input type="text" id="message" placeholder="Please enter a message.">
            <button id="send">SEND</button>
        </div>
    </div>

    <script>
        var socket = io();
        var user_id = null;

        // 4자리 ID 받기
        socket.on('user_id', function (data) {
            user_id = data.user_id;
            console.log("User ID assigned: " + user_id);
        });

        // 유저별로 색상을 저장할 객체
        var userColors = {};

        // 유저별로 고유한 연한 배경색을 생성하는 함수
        function getUserColor(user_id) {
            if (!userColors[user_id]) {
                // 연한 색상을 생성 (밝은 영역에서 랜덤 색상)
                const r = Math.floor(Math.random() * 100) + 156;  // R 값 (156-255)
                const g = Math.floor(Math.random() * 100) + 156;  // G 값 (156-255)
                const b = Math.floor(Math.random() * 100) + 156;  // B 값 (156-255)
                const randomColor = `rgb(${r}, ${g}, ${b})`;      // 연한 RGB 색상 생성
                userColors[user_id] = randomColor;
            }
            return userColors[user_id];
        }

        // 메시지 전송 (엔터 키로 전송)
        $('#send').click(function () {
            sendMessage();
        });

        $('#message').keypress(function (e) {
            if (e.which == 13) {
                sendMessage();
            }
        });

        function sendMessage() {
            var message = $('#message').val();
            var language = $('#language').val();
            var tone = $('#tone').val();
            var message_id = new Date().getTime();  // 고유한 메시지 ID 생성

            // 서버로 메시지 전송
            socket.emit('send_message', {
                'user_id': user_id,
                'message_id': message_id,
                'message': message,
                'language': language,
                'tone': tone
            });

            $('#message').val('');  // 메시지 입력 후 초기화
        }

        // 입력된 메시지 수신하여 왼쪽 창에 표시 (4자리 ID 포함, 말풍선 배경색 적용)
        socket.on('receive_original_message', function (data) {
            var userColor = getUserColor(data.user_id);  // 유저 배경색 가져오기
            var messageElement = '<p style="background-color: ' + userColor + '; padding: 10px; border-radius: 10px; margin-bottom: 10px;">USER_' + data.user_id + ': ' + data.message + '</p>';
            $('#original-box').append(messageElement);
            $('#original-box').scrollTop($('#original-box')[0].scrollHeight);
        });

        // 스트리밍된 번역 결과를 수신하여 오른쪽 창에 실시간으로 표시
        var translations = {};

        socket.on('stream_translation', function (data) {
            var mid = data.message_id;
            if (!translations[mid]) {
                translations[mid] = '';
            }

            // 이전 번역된 내용과 현재 스트리밍된 내용을 비교하여 중복 확인
            if (translations[mid].slice(-data.content.length) !== data.content) {
                translations[mid] += data.content;
            }

            var userColor = getUserColor(data.user_id);  // 유저 배경색 가져오기
            var messageElementId = 'translated-' + mid;
            var messageElement = $('#' + messageElementId);

            // 번역된 메시지를 처음 표시할 때
            if (messageElement.length === 0) {
                messageElement = $('<p id="' + messageElementId + '" style="background-color: ' + userColor + '; padding: 10px; border-radius: 10px; margin-bottom: 10px;">USER_' + data.user_id + ':</p>');
                $('#translated-box').append(messageElement);
            }

            // 업데이트된 번역된 내용을 표시
            messageElement.html('USER_' + data.user_id + ': ' + translations[mid]);
            $('#translated-box').scrollTop($('#translated-box')[0].scrollHeight);
        });

        // 번역 완료 시 처리 (옵션)
        socket.on('translation_done', function (data) {
            console.log("Translation complete for message: " + data.message_id);
        });

        // 번역 중 오류 처리
        socket.on('translation_error', function (data) {
            console.error("Translation error for message: " + data.message_id + ", error: " + data.error);
        });
    </script>
</body>

</html>